---
title: "Attendance check 11"
author: "22BA13260 - Tran Huy Quan"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=10, fig.height=6)
```

# Introduction

This report combines two Wavelet Analyses: 1. **Part 1**: El Niño-Southern Oscillation (ENSO) - Analyzing SOI vs SST. 2. **Part 2**: Delhi Climate Data - Analyzing Temperature vs Humidity.

Each section follows the same methodology: Initialization, Continuous Wavelet Transform (CWT), Cross Wavelet Transform (XWT), and Wavelet Coherence Transform (WTC).

# Setup

## Load Libraries

```{r libraries}
library(biwavelet)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(RColorBrewer)

theme_set(theme_bw(base_size = 14) +
          theme(panel.grid.minor = element_blank(),
                panel.grid.major = element_line(colour = "gray90", linetype="dashed"),
                legend.position = "bottom"))
```

------------------------------------------------------------------------

# Part 1: ENSO Analysis

This section analyzes the relationship between the **Southern Oscillation Index (SOI)** and **Sea Surface Temperature (SST)** anomalies.

## 1.1 Load and Prepare Data (ENSO)

We load the `ENSO_Data.csv` dataset.

```{r load-data-enso}
data_file <- "ENSO_Data.csv"

if (file.exists(data_file)) {
  # Load User Data
  raw_data <- read.csv(data_file)
  colnames(raw_data) <- tolower(colnames(raw_data))
  
  if("year" %in% names(raw_data) & "month" %in% names(raw_data)){
      raw_data$Date <- make_date(raw_data$year, raw_data$month, 1)
  } else if ("date" %in% names(raw_data)) {
      raw_data$Date <- as.Date(parse_date_time(raw_data$date, orders = c("ymd", "mdy", "dmy")))
  }
  
  numeric_cols <- select(raw_data, where(is.numeric)) %>% names()
  col_soi <- numeric_cols[grep("soi", numeric_cols)][1]
  col_sst <- numeric_cols[grep("sst|oni", numeric_cols)][1]
  
  if(is.na(col_soi) | is.na(col_sst)) {
      stop("Could not identify SOI and SST columns for Part 1.")
  }
  
  df_enso <- raw_data %>%
    rename(date = Date, soi = all_of(col_soi), sst = all_of(col_sst)) %>%
    select(date, soi, sst) %>%
    filter(!is.na(date) & !is.na(soi) & !is.na(sst)) %>%
    arrange(date)

} else {
  message("Warning: 'ENSO_Data.csv' not found. Generating SYNTHETIC data for Part 1.")
  
  t <- seq(1950, 2024, by = 1/12)
  n <- length(t)
  signal_common <- sin(2 * pi * t / 5) 
  
  df_enso <- data.frame(
    date = seq(as.Date("1950-01-01"), by = "month", length.out = n),
    soi = 0.8 * signal_common + rnorm(n, 0, 0.5),
    sst = -0.7 * signal_common + 0.3 * sin(2 * pi * t / 11) + rnorm(n, 0, 0.4)
  )
}

# Standardize
df_enso$soi_std <- as.vector(scale(df_enso$soi))
df_enso$sst_std <- as.vector(scale(df_enso$sst))

head(df_enso)
```

## 1.2 Visualize Time Series (ENSO)

```{r plot-initial-enso, fig.cap="Standardized Time Series: SOI vs SST"}
ggplot(df_enso, aes(x = date)) +
  geom_line(aes(y = soi_std, color = "Southern Oscillation Index (SOI)"), alpha = 0.7) +
  geom_line(aes(y = sst_std, color = "Sea Surface Temperature (SST)"), alpha = 0.7) +
  scale_color_manual(values = c("Southern Oscillation Index (SOI)" = "blue", 
                                "Sea Surface Temperature (SST)" = "red")) +
  labs(title = "ENSO: Standardized Time Series Comparison",
       y = "Standardized Anomaly", x = "Year") +
  theme(legend.title = element_blank())
```

## 1.3 Continuous Wavelet Transform (ENSO)

```{r cwt-calc-enso}
t_idx_enso <- decimal_date(df_enso$date)
cwt_soi <- wt(cbind(t_idx_enso, df_enso$soi_std), dj = 1/12, max.scale = 16, mother = "morlet", sig.test = 0)
cwt_sst <- wt(cbind(t_idx_enso, df_enso$sst_std), dj = 1/12, max.scale = 16, mother = "morlet", sig.test = 0)
```

```{r plot-cwt-enso, fig.height=10}
par(mfrow = c(2, 1), oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)

plot(cwt_soi, type = "power.corr.norm", 
     main = "(a) Continuous Wavelet Power: SOI",
     xlab = "Time (Year)", ylab = "Period (Years)",
     plot.cb = TRUE, plot.phase=FALSE)

plot(cwt_sst, type = "power.corr.norm", 
     main = "(b) Continuous Wavelet Power: SST",
     xlab = "Time (Year)", ylab = "Period (Years)",
     plot.cb = TRUE, plot.phase=FALSE)
```

## 1.4 Cross Wavelet Transform (ENSO)

```{r xwt-calc-enso}
xwt_enso <- xwt(cbind(t_idx_enso, df_enso$soi_std), 
                cbind(t_idx_enso, df_enso$sst_std), 
                sig.test = 0)
```

```{r plot-xwt-enso}
par(oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)
plot(xwt_enso, plot.cb = TRUE, plot.phase = TRUE,
     main = "Cross Wavelet Power Spectrum: SOI vs SST",
     xlab = "Time (Year)", ylab = "Period (Years)")
```

## 1.5 Wavelet Coherence (ENSO)

```{r wtc-calc-enso}
wtc_enso <- wtc(cbind(t_idx_enso, df_enso$soi_std), 
                cbind(t_idx_enso, df_enso$sst_std), 
                nrands = 100) 
```

```{r plot-wtc-enso}
par(oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)
plot(wtc_enso, plot.cb = TRUE, plot.phase = TRUE,
     main = "Wavelet Coherence: SOI vs SST",
     xlab = "Time (Year)", ylab = "Period (Years)",
     col.contour = "black")
```

## 1.6 Monte Carlo Simulation & Conclusion (ENSO)

The significance contours (black lines) in the plots above are calculated using Monte Carlo simulations against a red noise background (AR1 process).

### Interpretation

-   **CWT**: Both SOI and SST show significant power in the 2-7 year band (the classic ENSO cycle).
-   **XWT**: High common power confirms they are coupled systems.
-   **WTC**: High coherence (\>0.8) is observed consistently in the 2-7 year band.
-   **Phase**: The arrows predominantly point to the **left (anti-phase)**. When SST is high (El Niño), SOI is low.

------------------------------------------------------------------------

# Part 2: Delhi Climate Analysis

This section analyzes the relationship between **Mean Temperature** and **Humidity** in Delhi (2013-2017).

## 2.1 Load and Prepare Data (Delhi)

We load the `DailyDelhiClimateTest.csv` dataset.

```{r load-data-delhi}
data_url <- "https://raw.githubusercontent.com/pik1989/FBProphet/main/DailyDelhiClimateTrain.csv"
data_file_delhi <- "DailyDelhiClimateTrain.csv"

# Download data if not exists
if (!file.exists(data_file_delhi)) {
  tryCatch({
      download.file(data_url, destfile = data_file_delhi)
      message("Downloaded dataset from: ", data_url)
  }, error = function(e) {
      message("Could not download file. Checking for local copy...")
  })
}

if (file.exists(data_file_delhi)) {
  raw_data_delhi <- read.csv(data_file_delhi)
  colnames(raw_data_delhi) <- tolower(colnames(raw_data_delhi))
  
  if ("date" %in% names(raw_data_delhi)) {
      raw_data_delhi$date <- as.Date(parse_date_time(raw_data_delhi$date, orders = c("ymd", "mdy", "dmy")))
  }
  
  df_delhi <- raw_data_delhi %>%
    rename(series_x = meantemp, series_y = humidity) %>%
    select(date, series_x, series_y) %>%
    filter(!is.na(date) & !is.na(series_x) & !is.na(series_y)) %>%
    arrange(date)
    
  label_x_delhi <- "Mean Temperature"
  label_y_delhi <- "Humidity"

} else {
  message("Warning: Delhi Dataset not found. Using SYNTHETIC data for Part 2.")
  t <- seq(1950, 2024, by = 1/12) 
  n <- length(t)
  signal_common <- sin(2 * pi * t) 
  
  df_delhi <- data.frame(
    date = seq(as.Date("1950-01-01"), by = "month", length.out = n),
    series_x = 25 + 10 * signal_common + rnorm(n, 0, 2),
    series_y = 60 - 20 * signal_common + rnorm(n, 0, 5)
  )
  label_x_delhi <- "Synthetic Temp"
  label_y_delhi <- "Synthetic Humidity"
}

# Standardize
df_delhi$x_std <- as.vector(scale(df_delhi$series_x))
df_delhi$y_std <- as.vector(scale(df_delhi$series_y))

head(df_delhi)
```

## 2.2 Visualize Time Series (Delhi)

```{r plot-initial-delhi, fig.cap="Standardized Time Series: Delhi Climate"}
ggplot(df_delhi, aes(x = date)) +
  geom_line(aes(y = x_std, color = label_x_delhi), alpha = 0.7) +
  geom_line(aes(y = y_std, color = label_y_delhi), alpha = 0.7) +
  scale_color_manual(values = setNames(c("red", "blue"), c(label_x_delhi, label_y_delhi))) +
  labs(title = paste("Delhi:", label_x_delhi, "vs", label_y_delhi, "(Standardized)"),
       y = "Standardized Anomaly", x = "Date") +
  theme(legend.title = element_blank())
```

## 2.3 Continuous Wavelet Transform (Delhi)

```{r cwt-calc-delhi}
t_idx_delhi <- decimal_date(df_delhi$date)
cwt_x_delhi <- wt(cbind(t_idx_delhi, df_delhi$x_std), dj = 1/12, max.scale = 4, mother = "morlet", sig.test = 0)
cwt_y_delhi <- wt(cbind(t_idx_delhi, df_delhi$y_std), dj = 1/12, max.scale = 4, mother = "morlet", sig.test = 0)
```

```{r plot-cwt-delhi, fig.height=10}
par(mfrow = c(2, 1), oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)

plot(cwt_x_delhi, type = "power.corr.norm", 
     main = paste("(a) Continuous Wavelet Power:", label_x_delhi),
     xlab = "Time (Year)", ylab = "Period (Years)",
     plot.cb = TRUE, plot.phase=FALSE)

plot(cwt_y_delhi, type = "power.corr.norm", 
     main = paste("(b) Continuous Wavelet Power:", label_y_delhi),
     xlab = "Time (Year)", ylab = "Period (Years)",
     plot.cb = TRUE, plot.phase=FALSE)
```

## 2.4 Cross Wavelet Transform (Delhi)

```{r xwt-calc-delhi}
xwt_delhi <- xwt(cbind(t_idx_delhi, df_delhi$x_std), 
                 cbind(t_idx_delhi, df_delhi$y_std), 
                 sig.test = 0)
```

```{r plot-xwt-delhi}
par(oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)
plot(xwt_delhi, plot.cb = TRUE, plot.phase = TRUE,
     main = paste("Cross Wavelet Power Spectrum:", label_x_delhi, "vs", label_y_delhi),
     xlab = "Time (Year)", ylab = "Period (Years)")
```

## 2.5 Wavelet Coherence (Delhi)

```{r wtc-calc-delhi}
wtc_delhi <- wtc(cbind(t_idx_delhi, df_delhi$x_std), 
                 cbind(t_idx_delhi, df_delhi$y_std), 
                 nrands = 100) 
```

```{r plot-wtc-delhi}
par(oma = c(0, 0, 0, 1), mar = c(5, 4, 4, 5) + 0.1)
plot(wtc_delhi, plot.cb = TRUE, plot.phase = TRUE,
     main = paste("Wavelet Coherence:", label_x_delhi, "vs", label_y_delhi),
     xlab = "Time (Year)", ylab = "Period (Years)",
     col.contour = "black")
```

## 2.6 Monte Carlo Simulation & Conclusion (Delhi)

The significance contours (black lines) ensure patterns are statistically significant against red noise.

### Interpretation

-   **CWT**: We observe a strong 1-year dominant period, consistent with the annual seasonal cycle.
-   **XWT**: High common power at the 1-year band.
-   **WTC**: Strong coherence at the 1-year band.
-   **Phase**: The arrows pointing **Left** indicate an anti-phase relationship: deviations in Temperature are inversely related to Humidity (e.g., hotter days are drier).
